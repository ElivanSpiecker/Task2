name: Pipeline PHP com Flyway (Homolog + Produ√ß√£o)

on:
  push:
    branches: [main]
  workflow_dispatch: # permite executar manualmente tamb√©m

jobs:
  homolog:
    name: üîß Homologa√ß√£o
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ Checkout do c√≥digo
      uses: actions/checkout@v3

    - name: ‚öôÔ∏è Instalar PHP, Composer e depend√™ncias
      run: |
        sudo apt update
        sudo apt install php php-mbstring php-xml php-mysql unzip sshpass default-jre mysql-client -y
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install

    - name: ‚òÅÔ∏è Cache do Composer
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

    - name: ‚úÖ Garantir execu√ß√£o do PHPUnit
      run: chmod +x ./vendor/bin/phpunit

    - name: üß™ Rodar testes PHPUnit
      run: ./vendor/bin/phpunit --testdox
           ./vendor/bin/phpunit tests/TarefaTest.php --testdox
           ./vendor/bin/phpunit tests/UsuarioTest.php --testdox

    - name: üõ†Ô∏è Criar flyway.conf para Homologa√ß√£o
      run: |
        echo "flyway.url=${{ secrets.DB_URL_HOMOLOG }}" > flyway.conf
        echo "flyway.user=${{ secrets.DB_USER_HOMOLOG }}" >> flyway.conf
        echo "flyway.password=${{ secrets.DB_PASS_HOMOLOG }}" >> flyway.conf
        echo "flyway.locations=filesystem:./db/migrations" >> flyway.conf

    - name: üóÉÔ∏è Executar Flyway no banco de Homologa√ß√£o
      run: |
        wget https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/11.10.1/flyway-commandline-11.10.1-linux-x64.tar.gz
        tar -xvzf flyway-commandline-11.10.1-linux-x64.tar.gz
        ./flyway-11.10.1/flyway -configFiles=flyway.conf migrate

    - name: üöÄ Deploy para /var/www/homolog via SCP (sem .env)
      run: |
        find . -type f ! -name ".env" | xargs tar -czf deploy.tar.gz
        sshpass -p "${{ secrets.SSH_PASS_HOMOLOG }}" scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ secrets.SSH_USER_HOMOLOG }}@${{ secrets.SSH_HOST_HOMOLOG }}:/var/www/homolog
        sshpass -p "${{ secrets.SSH_PASS_HOMOLOG }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_HOMOLOG }}@${{ secrets.SSH_HOST_HOMOLOG }} "cd /var/www/homolog && tar -xzf deploy.tar.gz && rm deploy.tar.gz"

  producao:
    name: üöÄ Produ√ß√£o
    runs-on: ubuntu-latest
    needs: homolog # s√≥ executa se homolog passar

    steps:
    - name: üîÑ Checkout do c√≥digo
      uses: actions/checkout@v3

    - name: üõ†Ô∏è Criar flyway.conf para Produ√ß√£o
      run: |
        echo "flyway.url=${{ secrets.DB_URL_PROD }}" > flyway.conf
        echo "flyway.user=${{ secrets.DB_USER_PROD }}" >> flyway.conf
        echo "flyway.password=${{ secrets.DB_PASS_PROD }}" >> flyway.conf
        echo "flyway.locations=filesystem:./db/migrations" >> flyway.conf

    - name: üóÉÔ∏è Executar Flyway no banco de Produ√ß√£o
      run: |
        wget https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/11.10.1/flyway-commandline-11.10.1-linux-x64.tar.gz
        tar -xvzf flyway-commandline-11.10.1-linux-x64.tar.gz
        ./flyway-11.10.1/flyway -configFiles=flyway.conf migrate

    - name: üì¶ Deploy para /var/www/producao via SCP (sem .env)
      run: |
        find . -type f ! -name ".env" | xargs tar -czf deploy.tar.gz
        sshpass -p "${{ secrets.SSH_PASS_PROD }}" scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }}:/var/www/producao
        sshpass -p "${{ secrets.SSH_PASS_PROD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }} "cd /var/www/producao && tar -xzf deploy.tar.gz && rm deploy.tar.gz"
